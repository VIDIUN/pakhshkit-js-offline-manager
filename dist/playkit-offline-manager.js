!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("playkit-js"),require("shaka-player"),require("playkit-js-providers")):"function"==typeof define&&define.amd?define(["playkit-js","shaka-player","playkit-js-providers"],t):"object"==typeof exports?exports.OfflineManager=t(require("playkit-js"),require("shaka-player"),require("playkit-js-providers")):(e.playkit=e.playkit||{},e.playkit.OfflineManager=t(e.playkit.core,e.shaka,e.playkit.providers))}("undefined"!=typeof self?self:this,function(e,t,n){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=2)}([function(e,t,n){"use strict";function r(e){return e?u.get(e):u}function o(e){return r(e).getLevel()}function i(e,t){r(t).setLevel(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.setLogLevel=t.getLogLevel=t.LogLevel=void 0;var a=n(8),u=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t}(a),s={DEBUG:u.DEBUG,INFO:u.INFO,TIME:u.TIME,WARN:u.WARN,ERROR:u.ERROR,OFF:u.OFF};u.useDefaults({defaultLevel:u.ERROR}),t.default=r,t.LogLevel=s,t.getLogLevel=o,t.setLogLevel=i},function(t,n){t.exports=e},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NAME=t.VERSION=void 0;var r=n(3),o=function(e){return e&&e.__esModule?e:{default:e}}(r);t.default=o.default,t.VERSION="1.0.0",t.NAME="playkit-js-offline-manager"},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=n(4),s=n(9),l=n(1),c=n(0),f=function(e){return e&&e.__esModule?e:{default:e}}(c),d=function(e){function t(e){r(this,t),e.logLevel&&c.LogLevel[e.logLevel]&&(0,c.setLogLevel)(c.LogLevel[e.logLevel]),t._logger.debug("offline manager created");var n=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n._downloads?o(n):(n._downloads={},n._config=e,n._eventManager=new l.EventManager,n._setOfflineAdapter(),n)}return i(t,e),a(t,null,[{key:"isValid",value:function(){return!0}}]),a(t,[{key:"_setOfflineAdapter",value:function(){var e=this;this._offlineManager=new u.ShakaOfflineWrapper(this._downloads,this._config),this._eventManager.listen(this._offlineManager,u.PROGRESS_EVENT,function(t){e.dispatchEvent(t)})}},{key:"getMediaInfo",value:function(e){var n=this;return t._logger.debug("getMediaInfo",e.entryId),new Promise(function(r,o){return n._downloads[e.entryId]?r(n._downloads[e.entryId].sources.dash[0]):new s.Provider(n._config.provider).getMediaConfig(e).then(function(i){if(t._logger.debug("after provider.getMediaConfig"),l.Utils.Object.hasPropertyPath(i,"sources.dash")&&i.sources.dash.length>0){var a=i.sources.dash[0];return a.entryId=e.entryId,n._downloads[e.entryId]=i,r(a)}return t._logger.debug("getMediaInfo error"),o("getMediaInfo error")})})}},{key:"pause",value:function(e){return t._logger.debug("pause",e),this._offlineManager.pause(e)}},{key:"resume",value:function(e){return t._logger.debug("resume",e),this._offlineManager.resume(e)}},{key:"download",value:function(e,n){return t._logger.debug("download",e),this._offlineManager.download(e,n)}},{key:"remove",value:function(e){return t._logger.debug("remove",e),this._offlineManager.remove(e)}},{key:"getMediaInfoFromDB",value:function(e){return t._logger.debug("getMediaInfoFromDB",e),this._offlineManager.getDataByEntry(e)}},{key:"getAllDownloads",value:function(){return this._offlineManager.getAllDownloads()}},{key:"removeAll",value:function(){var e=this,t=[];return this.getAllDownloads().then(function(n){return n.forEach(function(n){t.push(e.remove(n.entryId))}),e._downloads={},Promise.all(t)})}},{key:"pauseAll",value:function(){var e=this,t=[];return this.getAllDownloads().then(function(n){return n.forEach(function(n){t.push(e.pause(n.entryId))}),Promise.all(t)})}},{key:"destroy",value:function(){this._eventManager.destroy()}},{key:"reset",value:function(){}}]),t}(l.FakeEventTarget);d._logger=(0,f.default)("OfflineManager"),t.default=d},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.ShakaOfflineWrapper=t.PROGRESS_EVENT=void 0;var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=n(5),l=r(s),c=n(6),f=r(c),d=n(1),g=n(0),p=r(g),h={DOWNLOADING:"downloading",PAUSED:"paused",RESUMED:"resumed",ENDED:"ended"},v={PAUSE:"pause",RESUME:"resume",DELETE:"delete",DOWNLOAD_START:"downloadStart",DOWNLOAD_END:"downloadEnd"},y=t.PROGRESS_EVENT="progress";(t.ShakaOfflineWrapper=function(e){function t(e){o(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return t._logger.debug("ShakaOfflineWrapper created"),n._dtgVideoElement=document.createElement("video"),l.default.polyfill.installAll(),n._dtgShaka=new l.default.Player(n._dtgVideoElement),l.default.log&&l.default.log.setLevel(l.default.log.Level.DEBUG),n._dbManager=new f.default({adapterName:"shaka",adapterVersion:"",playerVersion:""}),n._downloads=e,n._currentlyDownloaded=[],n}return a(t,e),u(t,[{key:"download",value:function(e,n){var r=this;t._logger.debug("download",e);var o=this._downloads[e];if(o.state)return Promise.reject("already downloading / resuming / paused");this._configureDrmIfNeeded(e),this._currentlyDownloaded.push(e),this._doesEntryExists(e).then(function(i){return i?Promise.reject("already downloading / paused"):(o.storage=r._initStorage(e,n),o.state=h.DOWNLOADING,o.storage.store(o.sources.dash[0].url,{}).then(function(n){return t._logger.debug("after storage.store",e),o.state=n.downloadStatus===h.PAUSED?h.PAUSED:h.ENDED,o.sources.dash[0].url=n.offlineUri,r._dbManager.add("entriesMap",e,r._prepareItemForStorage(o)).then(function(){t._logger.debug("after dbManager.add",e),Promise.resolve({action:v.DOWNLOAD_START,entryId:e})})}))}).catch(function(e){Promise.reject(e)})}},{key:"pause",value:function(e){var n=this;t._logger.debug("pause",e);var r=this._downloads[e];return r?[h.DOWNLOADING,h.RESUMED].includes(r.state)?r.storage.pause().then(function(){return t._logger.debug("after storage.pause",e),r.state=h.PAUSED,n._dbManager.update("entriesMap",e,n._prepareItemForStorage(r)).then(function(){t._logger.debug("after dbManager.update",e),Promise.resolve({entryId:e,action:v.PAUSE})})}).catch(function(e){Promise.reject(e)}):Promise.resolve():Promise.resolve("not downloading / resuming")}},{key:"resume",value:function(e){var n=this;return t._logger.debug("resume",e),this._setSessionData(e).then(function(){var r=n._downloads[e];r.state===h.PAUSED?(r.state=h.RESUMED,r.storage.resume(r.sources.dash[0].url).then(function(o){t._logger.debug("after storage.resume",e),r.state=[o.downloadStatus,o.ob].includes(h.ENDED)?h.ENDED:h.PAUSED,n._dbManager.update("entriesMap",e,n._prepareItemForStorage(r)).then(function(){return t._logger.debug("after dbManager.update",e),Promise.resolve({action:v.RESUME,entryId:e})})})):Promise.reject("already resumed / downloaded")}).catch(function(e){Promise.reject(e)})}},{key:"remove",value:function(e){var n=this;return t._logger.debug("remove",e),this._setSessionData(e).then(function(){var r=n._downloads[e];if(!r.state)return Promise.reject("Entry not found");r.storage.remove(r.sources.dash[0].url).then(function(){t._logger.debug("after storage.remove",e),n._dbManager.remove("entriesMap",e).then(function(){return t._logger.debug("after dbManager.remove",e),delete n._downloads[e],Promise.resolve({action:v.DELETED,entryId:e})})})}).catch(function(e){Promise.reject(e)})}},{key:"getDataByEntry",value:function(e){return this._dbManager.get("entriesMap",e)}},{key:"getAllDownloads",value:function(){return this._dbManager.getAll("entriesMap")}},{key:"_doesEntryExists",value:function(e){return this.getDataByEntry(e).then(function(e){return Promise.resolve(e&&e.state)})}},{key:"_configureDrmIfNeeded",value:function(e){t._logger.debug("_configureDrmIfNeeded",e);var n=this._downloads[e],r=n.sources.dash[0].drmData;if(r){var o={};r.forEach(function(e){o[e.scheme]=e.licenseUrl}),this._dtgShaka.configure({drm:{servers:o}})}else this._dtgShaka.configure({})}},{key:"_prepareItemForStorage",value:function(e){var t=["storage","url","mimetype"],n=Object.assign({},e);for(var r in n)t.includes(r)&&delete n[r];return n}},{key:"_setSessionData",value:function(e){var n=this;return t._logger.debug("_setSessionData",e),this._downloads[e]?Promise.resolve():this.getDataByEntry(e).then(function(t){var r=Object.assign({},t);return r.storage=n._initStorage(e),n._downloads[e]=r,Promise.resolve()})}},{key:"_initStorage",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t._logger.debug("_initStorage",e);var r=new l.default.offline.Storage(this._dtgShaka),o={usePersistentLicense:!0,progressCallback:this._setDownloadProgress(e)};return n&&n.trackSelectionCallback&&(o.trackSelectionCallback=n.trackSelectionCallback),r.configure(o),r}},{key:"_setDownloadProgress",value:function(e){var n=this;return t._logger.debug("_setDownloadProgress",e),function(t,r){var o=new d.FakeEvent(y,{detail:{content:t,progress:100*r,entryId:e}});n.dispatchEvent(o)}}}]),t}(d.FakeEventTarget))._logger=(0,p.default)("ShakaOfflineWrapper")},function(e,n){e.exports=t},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(7),u=r(a),s=n(0),l=r(s),c="offline-manager",f=function(){function e(t){o(this,e),e._logger.debug("DBManager created"),"indexedDB"in window&&(this.config=t,this.open(c))}return i(e,[{key:"open",value:function(t){this.dbPromise=u.default.open(t,1,function(t){e._logger.debug("open"),t.objectStoreNames.contains("entriesMap")||t.createObjectStore("entriesMap",{keyPath:"entryId"})})}},{key:"add",value:function(t,n,r){var o=this;return this.dbPromise.then(function(i){e._logger.debug("add");var a=i.transaction(t,"readwrite"),u=a.objectStore(t);return o._addConfigToItem(r),r.entryId=n,u.put(r),a.complete}).then(function(){})}},{key:"remove",value:function(t,n){return this.dbPromise.then(function(r){e._logger.debug("remove");var o=r.transaction(t,"readwrite");return o.objectStore(t).delete(n),o.complete})}},{key:"get",value:function(t,n){return this.dbPromise.then(function(r){return e._logger.debug("get",n),r.transaction(t).objectStore(t).get(n)}).then(function(e){return e})}},{key:"getAll",value:function(t){return this.dbPromise.then(function(n){return e._logger.debug("getAll"),n.transaction(t).objectStore(t).getAll()}).then(function(e){return e})}},{key:"removeAll",value:function(e){return e}},{key:"update",value:function(t,n,r){return e._logger.debug("update"),this.add(t,n,r)}},{key:"_addConfigToItem",value:function(e){for(var t in this.config)e[t]=this.config[t]}}]),e}();f._logger=(0,l.default)("DBManager"),t.default=f},function(e,t,n){"use strict";!function(){function t(e){return Array.prototype.slice.call(e)}function n(e){return new Promise(function(t,n){e.onsuccess=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function r(e,t,r){var o,i=new Promise(function(i,a){o=e[t].apply(e,r),n(o).then(i,a)});return i.request=o,i}function o(e,t,n){var o=r(e,t,n);return o.then(function(e){if(e)return new c(e,o.request)})}function i(e,t,n){n.forEach(function(n){Object.defineProperty(e.prototype,n,{get:function(){return this[t][n]},set:function(e){this[t][n]=e}})})}function a(e,t,n,o){o.forEach(function(o){o in n.prototype&&(e.prototype[o]=function(){return r(this[t],o,arguments)})})}function u(e,t,n,r){r.forEach(function(r){r in n.prototype&&(e.prototype[r]=function(){return this[t][r].apply(this[t],arguments)})})}function s(e,t,n,r){r.forEach(function(r){r in n.prototype&&(e.prototype[r]=function(){return o(this[t],r,arguments)})})}function l(e){this._index=e}function c(e,t){this._cursor=e,this._request=t}function f(e){this._store=e}function d(e){this._tx=e,this.complete=new Promise(function(t,n){e.oncomplete=function(){t()},e.onerror=function(){n(e.error)},e.onabort=function(){n(e.error)}})}function g(e,t,n){this._db=e,this.oldVersion=t,this.transaction=new d(n)}function p(e){this._db=e}i(l,"_index",["name","keyPath","multiEntry","unique"]),a(l,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),s(l,"_index",IDBIndex,["openCursor","openKeyCursor"]),i(c,"_cursor",["direction","key","primaryKey","value"]),a(c,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(e){e in IDBCursor.prototype&&(c.prototype[e]=function(){var t=this,r=arguments;return Promise.resolve().then(function(){return t._cursor[e].apply(t._cursor,r),n(t._request).then(function(e){if(e)return new c(e,t._request)})})})}),f.prototype.createIndex=function(){return new l(this._store.createIndex.apply(this._store,arguments))},f.prototype.index=function(){return new l(this._store.index.apply(this._store,arguments))},i(f,"_store",["name","keyPath","indexNames","autoIncrement"]),a(f,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),s(f,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),u(f,"_store",IDBObjectStore,["deleteIndex"]),d.prototype.objectStore=function(){return new f(this._tx.objectStore.apply(this._tx,arguments))},i(d,"_tx",["objectStoreNames","mode"]),u(d,"_tx",IDBTransaction,["abort"]),g.prototype.createObjectStore=function(){return new f(this._db.createObjectStore.apply(this._db,arguments))},i(g,"_db",["name","version","objectStoreNames"]),u(g,"_db",IDBDatabase,["deleteObjectStore","close"]),p.prototype.transaction=function(){return new d(this._db.transaction.apply(this._db,arguments))},i(p,"_db",["name","version","objectStoreNames"]),u(p,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(e){[f,l].forEach(function(n){n.prototype[e.replace("open","iterate")]=function(){var n=t(arguments),r=n[n.length-1],o=this._store||this._index,i=o[e].apply(o,n.slice(0,-1));i.onsuccess=function(){r(i.result)}}})}),[l,f].forEach(function(e){e.prototype.getAll||(e.prototype.getAll=function(e,t){var n=this,r=[];return new Promise(function(o){n.iterateCursor(e,function(e){return e?(r.push(e.value),void 0!==t&&r.length==t?void o(r):void e.continue()):void o(r)})})})});var h={open:function(e,t,n){var o=r(indexedDB,"open",[e,t]),i=o.request;return i.onupgradeneeded=function(e){n&&n(new g(i.result,e.oldVersion,i.transaction))},o.then(function(e){return new p(e)})},delete:function(e){return r(indexedDB,"deleteDatabase",[e])}};e.exports=h,e.exports.default=e.exports}()},function(e,t,n){var r,o;/*!
 * js-logger - http://github.com/jonnyreeves/js-logger
 * Jonny Reeves, http://jonnyreeves.co.uk/
 * js-logger may be freely distributed under the MIT license.
 */
!function(i){"use strict";var a={};a.VERSION="1.4.1";var u,s={},l=function(e,t){return function(){return t.apply(e,arguments)}},c=function(){var e,t,n=arguments,r=n[0];for(t=1;t<n.length;t++)for(e in n[t])e in r||!n[t].hasOwnProperty(e)||(r[e]=n[t][e]);return r},f=function(e,t){return{value:e,name:t}};a.DEBUG=f(1,"DEBUG"),a.INFO=f(2,"INFO"),a.TIME=f(3,"TIME"),a.WARN=f(4,"WARN"),a.ERROR=f(8,"ERROR"),a.OFF=f(99,"OFF");var d=function(e){this.context=e,this.setLevel(e.filterLevel),this.log=this.info};d.prototype={setLevel:function(e){e&&"value"in e&&(this.context.filterLevel=e)},getLevel:function(){return this.context.filterLevel},enabledFor:function(e){var t=this.context.filterLevel;return e.value>=t.value},debug:function(){this.invoke(a.DEBUG,arguments)},info:function(){this.invoke(a.INFO,arguments)},warn:function(){this.invoke(a.WARN,arguments)},error:function(){this.invoke(a.ERROR,arguments)},time:function(e){"string"==typeof e&&e.length>0&&this.invoke(a.TIME,[e,"start"])},timeEnd:function(e){"string"==typeof e&&e.length>0&&this.invoke(a.TIME,[e,"end"])},invoke:function(e,t){u&&this.enabledFor(e)&&u(t,c({level:e},this.context))}};var g=new d({filterLevel:a.OFF});!function(){var e=a;e.enabledFor=l(g,g.enabledFor),e.debug=l(g,g.debug),e.time=l(g,g.time),e.timeEnd=l(g,g.timeEnd),e.info=l(g,g.info),e.warn=l(g,g.warn),e.error=l(g,g.error),e.log=e.info}(),a.setHandler=function(e){u=e},a.setLevel=function(e){g.setLevel(e);for(var t in s)s.hasOwnProperty(t)&&s[t].setLevel(e)},a.getLevel=function(){return g.getLevel()},a.get=function(e){return s[e]||(s[e]=new d(c({name:e},g.context)))},a.createDefaultHandler=function(e){e=e||{},e.formatter=e.formatter||function(e,t){t.name&&e.unshift("["+t.name+"]")};var t={},n=function(e,t){Function.prototype.apply.call(e,console,t)};return"undefined"==typeof console?function(){}:function(r,o){r=Array.prototype.slice.call(r);var i,u=console.log;o.level===a.TIME?(i=(o.name?"["+o.name+"] ":"")+r[0],"start"===r[1]?console.time?console.time(i):t[i]=(new Date).getTime():console.timeEnd?console.timeEnd(i):n(u,[i+": "+((new Date).getTime()-t[i])+"ms"])):(o.level===a.WARN&&console.warn?u=console.warn:o.level===a.ERROR&&console.error?u=console.error:o.level===a.INFO&&console.info?u=console.info:o.level===a.DEBUG&&console.debug&&(u=console.debug),e.formatter(r,o),n(u,r))}},a.useDefaults=function(e){a.setLevel(e&&e.defaultLevel||a.DEBUG),a.setHandler(a.createDefaultHandler(e))},r=a,void 0!==(o="function"==typeof r?r.call(t,n,t,e):r)&&(e.exports=o)}()},function(e,t){e.exports=n}])});
//# sourceMappingURL=playkit-offline-manager.js.map