!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("playkit-js"),require("shaka-player"),require("playkit-js-providers")):"function"==typeof define&&define.amd?define(["playkit-js","shaka-player","playkit-js-providers"],t):"object"==typeof exports?exports.OfflineManager=t(require("playkit-js"),require("shaka-player"),require("playkit-js-providers")):(e.playkit=e.playkit||{},e.playkit.OfflineManager=t(e.playkit.core,e.shaka,e.playkit.providers))}("undefined"!=typeof self?self:this,function(e,t,n){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=1)}([function(t,n){t.exports=e},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NAME=t.VERSION=t.OfflineManager=void 0;var r=n(2),o=function(e){return e&&e.__esModule?e:{default:e}}(r);t.OfflineManager=o.default,t.VERSION="1.0.0",t.NAME="playkit-js-offline-manager"},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=n(3),s=function(e){return e&&e.__esModule?e:{default:e}}(u),c=n(7),l=n(0),f=function(e){function t(e){r(this,t);var n=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n._downloads?o(n):(n._downloads={},n._config=e,n._eventManager=new l.EventManager,n._setOfflineAdapter(),n)}return i(t,e),a(t,null,[{key:"isValid",value:function(){return!0}}]),a(t,[{key:"_setOfflineAdapter",value:function(){var e=this;this._offlineManager=new s.default(this._downloads),this._eventManager.listen(this._offlineManager,"progress",function(t){e.dispatchEvent(t)})}},{key:"getMediaInfo",value:function(e){var t=this;return new Promise(function(n,r){new c.Provider(t._config.provider).getMediaConfig(e).then(function(o){if(l.Utils.Object.hasPropertyPath(o,"sources.dash")&&o.sources.dash.length>0){var i=o.sources.dash[0];i.entryId=e.entryId,t._downloads[e.entryId]=o,n(i)}else r("getMediaInfo error")})})}},{key:"pause",value:function(e){return this._offlineManager.pause(e)}},{key:"resume",value:function(e){return this._offlineManager.resume(e)}},{key:"download",value:function(e,t){return this._offlineManager.download(e,t)}},{key:"deleteMedia",value:function(e){return this._offlineManager.deleteMedia(e)}},{key:"getMediaInfoFromDB",value:function(e){return this._offlineManager.getDataByEntry(e)}},{key:"getAllDownloads",value:function(){return this._offlineManager.getAllDownloads()}},{key:"destroy",value:function(){this._eventManager.destroy()}},{key:"reset",value:function(){}}]),t}(l.FakeEventTarget);t.default=f},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=n(4),c=r(s),l=n(5),f=r(l),d=n(0),p={DOWNLOADING:"downloading",PAUSED:"paused",RESUMED:"resumed",ENDED:"ended"},h={PAUSE:"pause",RESUME:"resume",DELETE:"delete",DOWNLOAD_START:"downloadStart",DOWNLOAD_END:"downloadEnd"},y=function(e){function t(e){o(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n._dtgVideoElement=document.createElement("video"),c.default.polyfill.installAll(),n._dtgShaka=new c.default.Player(n._dtgVideoElement),c.default.log&&c.default.log.setLevel(c.default.log.Level.DEBUG),n._dbManager=new f.default({adapterName:"shaka",adapterVersion:"",playerVersion:""}),n._downloads=e,n}return a(t,e),u(t,[{key:"download",value:function(e,t){var n=this,r=this._downloads[e];return this._configureDrmIfNeeded(e),r.storage=this._initStorage(e,t),r.state=p.DOWNLOADING,r.storage.store(r.sources.dash[0].url,{}).then(function(t){return r.state=t.downloadStatus===p.PAUSED?p.PAUSED:p.ENDED,r.sources.dash[0].url=t.offlineUri,n._dbManager.add("entriesMap",e,n._prepareItemForStorage(r)).then(function(){Promise.resolve({action:h.DOWNLOAD_START,entryId:e})})}).catch(function(e){Promise.reject(e)})}},{key:"pause",value:function(e){var t=this,n=this._downloads[e];return n?[p.DOWNLOADING,p.RESUMED].includes(n.state)?n.storage.pause().then(function(){return n.state=p.PAUSED,t._dbManager.update("entriesMap",e,t._prepareItemForStorage(n)).then(function(){Promise.resolve({entryId:e,action:h.PAUSE})})}).catch(function(e){Promise.reject(e)}):Promise.resolve():Promise.resolve("not downloading / resuming")}},{key:"resume",value:function(e){var t=this;return this._setSessionData(e).then(function(){var n=t._downloads[e];n.state===p.PAUSED&&(n.state=p.RESUMED,n.storage.resume(n.sources.dash[0].url).then(function(r){n.state=[r.downloadStatus,r.ob].includes(p.ENDED)?p.ENDED:p.PAUSED,t._dbManager.update("entriesMap",e,t._prepareItemForStorage(n)).then(function(){return Promise.resolve({action:h.RESUME,entryId:e})})}))}).catch(function(e){Promise.reject(e)})}},{key:"deleteMedia",value:function(e){var t=this;return this._setSessionData(e).then(function(){var n=t._downloads[e];n.state=p.DELETED,n.storage.remove(n.sources.dash[0].url).then(function(){t._dbManager.remove("entriesMap",e).then(function(){return delete t._downloads[e],Promise.resolve({action:h.DELETED,entryId:e})})})}).catch(function(e){Promise.reject(e)})}},{key:"getDataByEntry",value:function(e){return this._dbManager.get("entriesMap",e)}},{key:"getAllDownloads",value:function(){return this._dbManager.getAll("entriesMap")}},{key:"_configureDrmIfNeeded",value:function(e){var t=this._downloads[e],n=t.sources.dash[0].drmData;if(n){var r={};n.forEach(function(e){r[e.scheme]=e.licenseUrl}),this._dtgShaka.configure({drm:{servers:r}})}else this._dtgShaka.configure({})}},{key:"_prepareItemForStorage",value:function(e){var t=["storage","url","mimetype"],n=Object.assign({},e);for(var r in n)t.includes(r)&&delete n[r];return n}},{key:"_setSessionData",value:function(e){var t=this;return this._downloads[e]?Promise.resolve():this.getDataByEntry(e).then(function(n){var r=Object.assign({},n);return r.storage=t._initStorage(e),t._downloads[e]=r,Promise.resolve()})}},{key:"_initStorage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=new c.default.offline.Storage(this._dtgShaka),r={usePersistentLicense:!0,progressCallback:this._setDownloadProgress(e)};return t.trackSelectionCallback&&(r.trackSelectionCallback=t.trackSelectionCallback),n.configure(r),n}},{key:"_setDownloadProgress",value:function(e){var t=this;return function(n,r){var o=new d.FakeEvent("progress",{detail:{content:n,progress:100*r,entryId:e}});t.dispatchEvent(o)}}}]),t}(d.FakeEventTarget);t.default=y},function(e,n){e.exports=t},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(6),a=function(e){return e&&e.__esModule?e:{default:e}}(i),u="offline-manager",s=function(){function e(t){r(this,e),"indexedDB"in window&&(this.config=t,this.open(u))}return o(e,[{key:"open",value:function(e){this.dbPromise=a.default.open(e,1,function(e){e.objectStoreNames.contains("entriesMap")||e.createObjectStore("entriesMap",{keyPath:"entryId"})})}},{key:"add",value:function(e,t,n){var r=this;return this.dbPromise.then(function(o){var i=o.transaction(e,"readwrite"),a=i.objectStore(e);return r._addConfigToItem(n),n.entryId=t,a.put(n),i.complete}).then(function(){})}},{key:"remove",value:function(e,t){return this.dbPromise.then(function(n){var r=n.transaction(e,"readwrite");return r.objectStore(e).delete(t),r.complete})}},{key:"get",value:function(e,t){return this.dbPromise.then(function(n){return n.transaction(e).objectStore(e).get(t)}).then(function(e){return e})}},{key:"getAll",value:function(e){return this.dbPromise.then(function(t){return t.transaction(e).objectStore(e).getAll()}).then(function(e){return e})}},{key:"removeAll",value:function(e){return e}},{key:"update",value:function(e,t,n){return this.add(e,t,n)}},{key:"_addConfigToItem",value:function(e){for(var t in this.config)e[t]=this.config[t]}}]),e}();t.default=s},function(e,t,n){"use strict";!function(){function t(e){return Array.prototype.slice.call(e)}function n(e){return new Promise(function(t,n){e.onsuccess=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function r(e,t,r){var o,i=new Promise(function(i,a){o=e[t].apply(e,r),n(o).then(i,a)});return i.request=o,i}function o(e,t,n){var o=r(e,t,n);return o.then(function(e){if(e)return new l(e,o.request)})}function i(e,t,n){n.forEach(function(n){Object.defineProperty(e.prototype,n,{get:function(){return this[t][n]},set:function(e){this[t][n]=e}})})}function a(e,t,n,o){o.forEach(function(o){o in n.prototype&&(e.prototype[o]=function(){return r(this[t],o,arguments)})})}function u(e,t,n,r){r.forEach(function(r){r in n.prototype&&(e.prototype[r]=function(){return this[t][r].apply(this[t],arguments)})})}function s(e,t,n,r){r.forEach(function(r){r in n.prototype&&(e.prototype[r]=function(){return o(this[t],r,arguments)})})}function c(e){this._index=e}function l(e,t){this._cursor=e,this._request=t}function f(e){this._store=e}function d(e){this._tx=e,this.complete=new Promise(function(t,n){e.oncomplete=function(){t()},e.onerror=function(){n(e.error)},e.onabort=function(){n(e.error)}})}function p(e,t,n){this._db=e,this.oldVersion=t,this.transaction=new d(n)}function h(e){this._db=e}i(c,"_index",["name","keyPath","multiEntry","unique"]),a(c,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),s(c,"_index",IDBIndex,["openCursor","openKeyCursor"]),i(l,"_cursor",["direction","key","primaryKey","value"]),a(l,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(e){e in IDBCursor.prototype&&(l.prototype[e]=function(){var t=this,r=arguments;return Promise.resolve().then(function(){return t._cursor[e].apply(t._cursor,r),n(t._request).then(function(e){if(e)return new l(e,t._request)})})})}),f.prototype.createIndex=function(){return new c(this._store.createIndex.apply(this._store,arguments))},f.prototype.index=function(){return new c(this._store.index.apply(this._store,arguments))},i(f,"_store",["name","keyPath","indexNames","autoIncrement"]),a(f,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),s(f,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),u(f,"_store",IDBObjectStore,["deleteIndex"]),d.prototype.objectStore=function(){return new f(this._tx.objectStore.apply(this._tx,arguments))},i(d,"_tx",["objectStoreNames","mode"]),u(d,"_tx",IDBTransaction,["abort"]),p.prototype.createObjectStore=function(){return new f(this._db.createObjectStore.apply(this._db,arguments))},i(p,"_db",["name","version","objectStoreNames"]),u(p,"_db",IDBDatabase,["deleteObjectStore","close"]),h.prototype.transaction=function(){return new d(this._db.transaction.apply(this._db,arguments))},i(h,"_db",["name","version","objectStoreNames"]),u(h,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(e){[f,c].forEach(function(n){n.prototype[e.replace("open","iterate")]=function(){var n=t(arguments),r=n[n.length-1],o=this._store||this._index,i=o[e].apply(o,n.slice(0,-1));i.onsuccess=function(){r(i.result)}}})}),[c,f].forEach(function(e){e.prototype.getAll||(e.prototype.getAll=function(e,t){var n=this,r=[];return new Promise(function(o){n.iterateCursor(e,function(e){return e?(r.push(e.value),void 0!==t&&r.length==t?void o(r):void e.continue()):void o(r)})})})});var y={open:function(e,t,n){var o=r(indexedDB,"open",[e,t]),i=o.request;return i.onupgradeneeded=function(e){n&&n(new p(i.result,e.oldVersion,i.transaction))},o.then(function(e){return new h(e)})},delete:function(e){return r(indexedDB,"deleteDatabase",[e])}};e.exports=y,e.exports.default=e.exports}()},function(e,t){e.exports=n}])});
//# sourceMappingURL=playkit-offline-manager.js.map