!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("shaka-player"),require("playkit-js-providers"),require("playkit-js")):"function"==typeof define&&define.amd?define(["shaka-player","playkit-js-providers","playkit-js"],t):"object"==typeof exports?exports.OfflineManager=t(require("shaka-player"),require("playkit-js-providers"),require("playkit-js")):(e.playkit=e.playkit||{},e.playkit.OfflineManager=t(e.shaka,e.playkit.providers,e.playkit.core))}("undefined"!=typeof self?self:this,function(e,t,n){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NAME=t.VERSION=t.OfflineManager=void 0;var r=n(1),o=function(e){return e&&e.__esModule?e:{default:e}}(r);t.OfflineManager=o.default,t.VERSION="1.0.0",t.NAME="playkit-js-offline-manager"},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(2),a=function(e){return e&&e.__esModule?e:{default:e}}(i),u=n(6),s=n(7),c=function(){function e(t){r(this,e),this._downloads||(this._downloads={},this._config=t,this._setOfflineAdapter())}return o(e,null,[{key:"isValid",value:function(){return!0}}]),o(e,[{key:"_setOfflineAdapter",value:function(){this._offlineManager=new a.default(this._downloads)}},{key:"getMediaInfo",value:function(e){var t=this;return new Promise(function(n,r){new u.Provider(t._config.provider).getMediaConfig(e).then(function(o){if(s.Utils.Object.hasPropertyPath(o,"sources.dash")&&o.sources.dash.length>0){var i=o.sources.dash[0];i.entryId=e.entryId,t._downloads[e.entryId]=o,n(i)}else r("getMediaInfo error")})})}},{key:"pause",value:function(e){return this._offlineManager.pause(e)}},{key:"resume",value:function(e){return this._offlineManager.resume(e)}},{key:"download",value:function(e,t){return this._offlineManager.download(e,t)}},{key:"deleteMedia",value:function(e){return this._offlineManager.deleteMedia(e)}},{key:"getMediaInfoFromDB",value:function(e){return this._offlineManager.getDataByEntry(e)}},{key:"destroy",value:function(){}},{key:"reset",value:function(){}}]),e}();t.default=c},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),a=n(3),u=r(a),s=n(4),c=r(s),f={DOWNLOADING:"downloading",PAUSED:"paused",RESUMED:"resumed",ENDED:"ended"},l={PAUSE:"pause",RESUME:"resume",DELETE:"delete",DOWNLOAD_START:"downloadStart",DOWNLOAD_END:"downloadEnd"},d=function(){function e(t){o(this,e),this._dtgVideoElement=document.createElement("video"),u.default.polyfill.installAll(),this._dtgShaka=new u.default.Player(this._dtgVideoElement),u.default.log&&u.default.log.setLevel(u.default.log.Level.DEBUG),this._dbManager=new c.default({adapterName:"shaka",adapterVersion:"",playerVersion:""}),this._downloads=t}return i(e,[{key:"download",value:function(e,t){var n=this,r=this._downloads[e];return this._configureDrmIfNeeded(e),r.storage=this._initStorage(e),r.state=f.DOWNLOADING,r.storage.store(r.sources.dash[0].url,t).then(function(t){return r.sources.dash[0].url=t.offlineUri,n._dbManager.add("entriesMap",e,n._prepareItemForStorage(r)).then(function(){Promise.resolve({action:l.DOWNLOAD_START,entryId:e})})}).catch(function(e){Promise.reject(e)})}},{key:"pause",value:function(e){var t=this,n=this._downloads[e];return n?[f.DOWNLOADING,f.RESUMED].includes(n.state)?n.storage.pause().then(function(){return n.state=f.PAUSED,t._dbManager.update("entriesMap",e,t._prepareItemForStorage(n)).then(function(){Promise.resolve({entryId:e,action:l.PAUSE})})}).catch(function(e){}):Promise.resolve():Promise.resolve("not downloading / resuming")}},{key:"resume",value:function(e){var t=this;return this._setSessionData(e).then(function(){var n=t._downloads[e];n.state===f.PAUSED&&(n.state=f.RESUMED,n.storage.resume(n.sources.dash[0].url).then(function(){t._dbManager.update("entriesMap",e,t._prepareItemForStorage(n)).then(function(){return Promise.resolve({action:l.RESUME,entryId:e})})}))}).catch(function(e){})}},{key:"deleteMedia",value:function(e){var t=this;return this._setSessionData(e).then(function(){var n=t._downloads[e];n.state=f.DELETED,n.storage.remove(currentDownload.sources.dash[0].url).then(function(){t._dbManager.remove("entriesMap",e).then(function(){return delete t._downloads[e],Promise.resolve({action:l.DELETED,entryId:e})})})}).catch(function(e){})}},{key:"getDataByEntry",value:function(e){return this._dbManager.get("entriesMap",e)}},{key:"_configureDrmIfNeeded",value:function(e){var t=this._downloads[e],n=t.sources.dash[0].drmData;if(n){var r={};n.forEach(function(e){r[e.scheme]=e.licenseUrl}),this._dtgShaka.configure({drm:{servers:r}})}else this._dtgShaka.configure({})}},{key:"_prepareItemForStorage",value:function(e){var t=["storage","url","mimetype"],n=Object.assign({},e);for(var r in n)t.includes(r)&&delete n[r];return n}},{key:"_setSessionData",value:function(e){var t=this;return this._downloads[e]?Promise.resolve():this.getDataByEntry(e).then(function(n){var r=Object.assign({},n);return r.storage=t._initStorage(e),t._downloads[e]=r,Promise.resolve()})}},{key:"_initStorage",value:function(e){var t=new u.default.offline.Storage(this._dtgShaka);return t.configure({usePersistentLicense:!1,progressCallback:this._setDownloadProgress(e)}),t}},{key:"_setDownloadProgress",value:function(e){return function(t,n){var r=new CustomEvent("progress",{detail:{content:t,progress:100*n,entryId:e}});window.dispatchEvent(r)}}}]),e}();t.default=d},function(t,n){t.exports=e},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),i=n(5),a=function(e){return e&&e.__esModule?e:{default:e}}(i),u="offline-manager",s=function(){function e(t){r(this,e),"indexedDB"in window&&(this.config=t,this.open(u))}return o(e,[{key:"open",value:function(e){this.dbPromise=a.default.open(e,1,function(e){e.objectStoreNames.contains("entriesMap")||e.createObjectStore("entriesMap",{keyPath:"entryId"})})}},{key:"add",value:function(e,t,n){var r=this;return this.dbPromise.then(function(o){var i=o.transaction(e,"readwrite"),a=i.objectStore(e);return r._addConfigToItem(n),n.entryId=t,a.put(n),i.complete}).then(function(){})}},{key:"remove",value:function(e,t){return this.dbPromise.then(function(n){var r=n.transaction(e,"readwrite");return r.objectStore(e).delete(t),r.complete})}},{key:"get",value:function(e,t){return this.dbPromise.then(function(n){return n.transaction(e).objectStore(e).get(t)}).then(function(e){return e})}},{key:"getAll",value:function(e){return this.dbPromise.then(function(t){return t.transaction(e).objectStore(e).getAll()}).then(function(e){return e})}},{key:"removeAll",value:function(e){return e}},{key:"update",value:function(e,t,n){return this.add(e,t,n)}},{key:"_addConfigToItem",value:function(e){for(var t in this.config)e[t]=this.config[t]}}]),e}();t.default=s},function(e,t,n){"use strict";!function(){function t(e){return Array.prototype.slice.call(e)}function n(e){return new Promise(function(t,n){e.onsuccess=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function r(e,t,r){var o,i=new Promise(function(i,a){o=e[t].apply(e,r),n(o).then(i,a)});return i.request=o,i}function o(e,t,n){var o=r(e,t,n);return o.then(function(e){if(e)return new f(e,o.request)})}function i(e,t,n){n.forEach(function(n){Object.defineProperty(e.prototype,n,{get:function(){return this[t][n]},set:function(e){this[t][n]=e}})})}function a(e,t,n,o){o.forEach(function(o){o in n.prototype&&(e.prototype[o]=function(){return r(this[t],o,arguments)})})}function u(e,t,n,r){r.forEach(function(r){r in n.prototype&&(e.prototype[r]=function(){return this[t][r].apply(this[t],arguments)})})}function s(e,t,n,r){r.forEach(function(r){r in n.prototype&&(e.prototype[r]=function(){return o(this[t],r,arguments)})})}function c(e){this._index=e}function f(e,t){this._cursor=e,this._request=t}function l(e){this._store=e}function d(e){this._tx=e,this.complete=new Promise(function(t,n){e.oncomplete=function(){t()},e.onerror=function(){n(e.error)},e.onabort=function(){n(e.error)}})}function p(e,t,n){this._db=e,this.oldVersion=t,this.transaction=new d(n)}function h(e){this._db=e}i(c,"_index",["name","keyPath","multiEntry","unique"]),a(c,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),s(c,"_index",IDBIndex,["openCursor","openKeyCursor"]),i(f,"_cursor",["direction","key","primaryKey","value"]),a(f,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(e){e in IDBCursor.prototype&&(f.prototype[e]=function(){var t=this,r=arguments;return Promise.resolve().then(function(){return t._cursor[e].apply(t._cursor,r),n(t._request).then(function(e){if(e)return new f(e,t._request)})})})}),l.prototype.createIndex=function(){return new c(this._store.createIndex.apply(this._store,arguments))},l.prototype.index=function(){return new c(this._store.index.apply(this._store,arguments))},i(l,"_store",["name","keyPath","indexNames","autoIncrement"]),a(l,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),s(l,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),u(l,"_store",IDBObjectStore,["deleteIndex"]),d.prototype.objectStore=function(){return new l(this._tx.objectStore.apply(this._tx,arguments))},i(d,"_tx",["objectStoreNames","mode"]),u(d,"_tx",IDBTransaction,["abort"]),p.prototype.createObjectStore=function(){return new l(this._db.createObjectStore.apply(this._db,arguments))},i(p,"_db",["name","version","objectStoreNames"]),u(p,"_db",IDBDatabase,["deleteObjectStore","close"]),h.prototype.transaction=function(){return new d(this._db.transaction.apply(this._db,arguments))},i(h,"_db",["name","version","objectStoreNames"]),u(h,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(e){[l,c].forEach(function(n){n.prototype[e.replace("open","iterate")]=function(){var n=t(arguments),r=n[n.length-1],o=this._store||this._index,i=o[e].apply(o,n.slice(0,-1));i.onsuccess=function(){r(i.result)}}})}),[c,l].forEach(function(e){e.prototype.getAll||(e.prototype.getAll=function(e,t){var n=this,r=[];return new Promise(function(o){n.iterateCursor(e,function(e){return e?(r.push(e.value),void 0!==t&&r.length==t?void o(r):void e.continue()):void o(r)})})})});var y={open:function(e,t,n){var o=r(indexedDB,"open",[e,t]),i=o.request;return i.onupgradeneeded=function(e){n&&n(new p(i.result,e.oldVersion,i.transaction))},o.then(function(e){return new h(e)})},delete:function(e){return r(indexedDB,"deleteDatabase",[e])}};e.exports=y,e.exports.default=e.exports}()},function(e,n){e.exports=t},function(e,t){e.exports=n}])});
//# sourceMappingURL=playkit-offline-manager.js.map